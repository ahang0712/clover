# 并发缺陷检测工具

## 简介

本目录包含用于检测嵌入式系统并发缺陷的静态分析工具。工具基于对读写操作序列的分析，可以检测四种常见的并发缺陷模式：

- **RWR (Read-Write-Read)**: 连续读操作可能被中断写操作破坏
- **RWW (Read-Write-Write)**: 读后写操作可能被中断写操作覆盖
- **WRW (Write-Read-Write)**: 连续写操作之间的读操作可能读取中间状态
- **WWR (Write-Write-Read)**: 写后读操作可能被中断写操作破坏

## 工具文件

- `pattern.py`: 原始的并发缺陷检测工具，基于JSON格式的操作列表
- `llvm_pattern.py`: 改进版的并发缺陷检测工具，直接基于LLVM IR进行分析

## 改进版工具的主要优势

新的`llvm_pattern.py`相对于原始的`pattern.py`有以下改进：

1. **直接解析LLVM IR**
   - 无需中间JSON格式，直接从LLVM IR中提取信息
   - 减少了工具链中的数据转换步骤，提高了效率和准确性

2. **基本块级别分析**
   - 考虑了代码在基本块中的执行顺序
   - 可以更准确地判断操作的真实执行序列

3. **调用图分析**
   - 构建完整的函数调用图
   - 可以识别跨函数的操作序列和可达性

4. **变量依赖分析**
   - 跟踪指令中的变量依赖关系
   - 可以更准确地判断数据流和控制流的关系

5. **路径敏感分析**
   - 分析不同执行路径上的操作序列
   - 减少误报，提高检测准确性

## 使用方法

### 原始工具 (pattern.py)

```bash
python pattern.py <JSON文件路径>...
```

### 改进版工具 (llvm_pattern.py)

```bash
python llvm_pattern.py <LLVM IR文件路径> [输出文件路径]
```

## 输出格式

两个工具的输出格式相同，都是文本文件，包含检测到的缺陷信息：

```
Defect_Pattern: <缺陷类型>
Variable: <变量名>
Location: <位置信息>
Description: <缺陷描述>
---
```

## 对比示例

假设有以下C代码片段：

```c
volatile int global_var;

void main() {
  int temp = global_var;  // 读
  global_var = 10;        // 写
}

void isr() {
  global_var = 20;        // 写
}
```

### 原始工具分析

原始工具会检测到RWW缺陷，但不会考虑实际的执行路径。

### 改进版工具分析

改进版工具会：
1. 解析LLVM IR提取操作序列
2. 识别基本块中的指令顺序
3. 确认操作确实在可达路径上
4. 然后报告RWW缺陷

## 注意事项

- 两个工具都假设中断函数按照名称排序代表其优先级
- 改进版工具需要LLVM IR作为输入，可以通过`clang -O0 -g -emit-llvm -S <C文件> -o <输出.ll文件>`生成 